{% extends 'base.html' %}
{% block title %}Manage Test Groups{% endblock %}
{% block head %}
{{ super() }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
<style>
    .testgroup-container {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        margin-left: 0;
        padding-left: 0;
        width: 100%;
    }

    .box {
        width: 47%;
        border: 1px solid #ccc;
        padding: 10px;
        height: 400px;
        overflow-y: auto;
        background: #f9f9f9;
    }

    .controls {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 3%;
    }

    .controls button {
        margin: 10px 0;
        width: 50px;
    }

    .quick-select {
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .quick-select form {
        display: inline-block;
    }

    .quick-select button {
        margin-right: 5px;
    }

    .select2-container {
        width: 200px !important;
    }

    .flash-messages {
        margin-bottom: 15px;
    }

    .group-forms {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .group-form {
        flex: 1;
        max-width: 300px;
    }

    .test-tree {
        margin: 5px 0;
    }

    .test-item {
        padding-left: 20px;
        display: flex;
        align-items: center;
    }

    .test-branch {
        cursor: pointer;
        font-weight: bold;
    }

    .test-branch::before {
        content: '▼ ';
    }

    .test-branch.collapsed::before {
        content: '▶ ';
    }
</style>
{% endblock %}
{% block content %}
<h1>Manage Test Groups</h1>


<!-- Group Selection and Forms -->
<div class="mb-3">
    <form method="GET" action="{{ url_for('manage_test_groups') }}">
        <label for="group_id" class="form-label">Select Group:</label>
        <select name="group_id" id="group_id" class="form-select">
            <option value="">-- Select a Group --</option>
            {% for group in groups %}
            <option value="{{ group.id }}" {% if selected_group and selected_group.id==group.id %}selected{% endif %}>
                {{ group.name }}
            </option>
            {% endfor %}
        </select>
    </form>
</div>
<div class="group-forms">
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None, filter=filter_type, device_id=selected_device_id) }}"
        class="group-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="create_group">
        <div class="mb-3">
            <label for="create_group_name" class="form-label">Create New Group:</label>
            <input type="text" name="group_name" id="create_group_name" class="form-control"
                placeholder="Enter group name" value="{{ group_name or '' }}">
        </div>
        <button type="submit" class="btn btn-primary">Create Group</button>
    </form>
    {% if selected_group and selected_group.created_by_id == current_user.id %}
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id, filter=filter_type, device_id=selected_device_id) }}"
        class="group-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="update_group">
        <div class="mb-3">
            <label for="edit_group_name" class="form-label">Edit Group Name:</label>
            <input type="text" name="group_name" id="edit_group_name" class="form-control"
                value="{{ selected_group.name }}">
        </div>
        <button type="submit" class="btn btn-primary">Update Group</button>
    </form>
    {% endif %}
</div>

<!-- Quick-Select Filters -->
{% set can_edit = selected_group and selected_group.created_by_id == current_user.id %}
<div class="quick-select">
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="created_by_me">
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>All Tests Created by
            Me</button>
    </form>
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="bgpaspath_test">
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>All BGP AS Path
            Tests</button>
    </form>
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="itraceroute_test">
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>All iTraceroute
            Tests</button>
    </form>
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="traceroute_test">
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>All Traceroute
            Tests</button>
    </form>
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="ping_test">
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>All Ping Tests</button>
    </form>
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="txrxtransceiver_test">
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>All TxRx Transceiver
            Tests</button>
    </form>
    <form method="POST"
        action="{{ url_for('manage_test_groups', group_id=selected_group.id if selected_group else None) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_filter_tests">
        <input type="hidden" name="filter" value="device_tests">
        <label for="device_id" class="form-label">All Tests for Device:</label>
        <select name="device_id" id="device_id" class="form-select">
            <option value="">-- Select Device --</option>
            {% for device in devices %}
            <option value="{{ device.id }}" {% if selected_device_id==device.id %}selected{% endif %}>
                {{ device.hostname }}
            </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-secondary" {% if not can_edit %}disabled{% endif %}>Add Device
            Tests</button>
    </form>

</div>

<!-- Test Management -->
{% if selected_group %}
<div class="testgroup-container">
    <!-- Available Tests (Left Box) -->
    <div class="box" id="available_tests_box">
        <h3>Available Tests</h3>
        <button type="button" class="btn btn-outline-secondary mb-2" onclick="selectAllTests('available_tests_box')" {%
            if not can_edit %}disabled{% endif %}>Select All</button>
        <button type="button" class="btn btn-outline-secondary mb-2" onclick="deselectAllTests('available_tests_box')"
            {% if not can_edit %}disabled{% endif %}>Deselect All</button>
        <form method="POST"
            action="{{ url_for('manage_test_groups', group_id=selected_group.id, filter=filter_type, device_id=selected_device_id) }}"
            id="add-tests-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_tests">
            <div class="test-tree">
                {% for test_type, data in available_tests.items() %}
                <div class="test-branch" data-bs-toggle="collapse" data-bs-target="#available-{{ test_type }}-tests">
                    {{ data.display_name }} ({{ data.tests|length }})
                </div>
                <div class="collapse" id="available-{{ test_type }}-tests">
                    {% for test in data.tests %}
                    <div class="test-item">
                        <input type="checkbox" name="selected_tests" value="{{ test.id }}:{{ test.type }}" {% if not
                            can_edit %}disabled{% endif %}>
                        <span title="Test {{ test.id }}: {{ test.device_hostname }}">{{ test.name }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </form>
    </div>

    <!-- Controls (Move Buttons) -->
    <div class="controls">
        <button type="submit" form="add-tests-form" class="btn btn-primary" {% if not can_edit %}disabled{% endif
            %}>&gt;</button>
        <button type="submit" form="remove-tests-form" class="btn btn-primary" {% if not can_edit %}disabled{% endif
            %}>&lt;</button>
    </div>

    <!-- Group Tests (Right Box) -->
    <div class="box" id="group_tests_box">
        <h3>Tests in {{ selected_group.name }}</h3>
        <button type="button" class="btn btn-outline-secondary mb-2" onclick="selectAllTests('group_tests_box')" {% if
            not can_edit %}disabled{% endif %}>Select All</button>
        <button type="button" class="btn btn-outline-secondary mb-2" onclick="deselectAllTests('group_tests_box')" {% if
            not can_edit %}disabled{% endif %}>Deselect All</button>
        <form method="POST"
            action="{{ url_for('manage_test_groups', group_id=selected_group.id, filter=filter_type, device_id=selected_device_id) }}"
            id="remove-tests-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="remove_tests">
            <div class="test-tree">
                {% for test_type, data in group_tests.items() %}
                <div class="test-branch" data-bs-toggle="collapse" data-bs-target="#group-{{ test_type }}-tests">
                    {{ data.display_name }} ({{ data.tests|length }})
                </div>
                <div class="collapse" id="group-{{ test_type }}-tests">
                    {% for test in data.tests %}
                    <div
                        class="test-item {{ 'bold' if test.id|string + ':' + test.type in request.form.getlist('selected_tests') }}">
                        <input type="checkbox" name="group_tests" value="{{ test.id }}:{{ test.type }}" {% if not
                            can_edit %}disabled{% endif %}>
                        <span title="Test {{ test.id }}: {{ test.device_hostname }}">{{ test.name }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </form>
    </div>
</div>
{% else %}
<p>Please select or create a group to manage tests.</p>
{% endif %}
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#group_id').select2({ placeholder: "-- Select a Group --", allowClear: true });
        $('#device_id').select2({ placeholder: "-- Select Device --", allowClear: true });
        $('#group_id').on('change', function () {
            $(this).closest('form').submit();
        });
        $('#device_id').on('change', function () {
            $(this).closest('form').submit();
        });

        // Initialize all test branches as collapsed
        $('.test-branch').addClass('collapsed');

        // Sync .collapsed class with Bootstrap collapse events
        $('.collapse').on('shown.bs.collapse', function () {
            const branch = $(`[data-bs-target="#${$(this).attr('id')}"]`);
            branch.removeClass('collapsed');
        }).on('hidden.bs.collapse', function () {
            const branch = $(`[data-bs-target="#${$(this).attr('id')}"]`);
            branch.addClass('collapsed');
        });
    });

    function selectAllTests(boxId) {
        const checkboxes = document.querySelectorAll(`#${boxId} input[type='checkbox']`);
        checkboxes.forEach(checkbox => checkbox.checked = true);
    }

    function deselectAllTests(boxId) {
        const checkboxes = document.querySelectorAll(`#${boxId} input[type='checkbox']`);
        checkboxes.forEach(checkbox => checkbox.checked = false);
    }
</script>
{% endblock %}