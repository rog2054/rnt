{% extends 'base.html' %}
{% block title %}Test Results - Run {{ run_id }}{% endblock %}
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1>Results: {{ run_description }}</h1>
    {% if run_timestamp %}
    <p class="text-muted">Tests Run: {{ run_timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
    {% else %}
    <p class="text-muted">Test execution timestamp not available</p>
    {% endif %}
    <p>
        {% if all_bgp_tests_passed %}
        <span class="perfect">üíØ</span>
        {% else %}
        <span class="incomplete">‚ùå</span>
        {% endif %}
        <strong>BGP Tests</strong> {{ bgp_pass }} pass, {{ bgp_fail }} fail
        <br />

        {% if
        all_traceroute_tests_passed %}
        <span class="perfect">üíØ</span>
        {% else %}
        <span class="incomplete">‚ùå</span>
        {% endif %}
        <strong>Traceroute Tests</strong> {{ traceroute_pass }} pass, {{ traceroute_fail }} fail
    </p>

    <!-- BGP Tests Table -->
    <h2>BGP Tests</h2>
    <table class="table table-striped" id="bgp-table">
        <thead>
            <tr>
                <th class="sortable">Tested from Device</th>
                <th class="sortable">Test Description</th>
                <th class="sortable">Prefix Tested</th>
                <th class="sortable">AS Checked</th>
                <th class="sortable">Result</th>
            </tr>
        </thead>
        <tbody>
            {% for test_instance, result, device, bgp_test in bgp_results %}
            <tr class="summary-row" data-toggle-id="bgp-{{ test_instance.id }}">
                <td>{{ device.siteinfo or device.hostname }}</td>
                <td>{{ bgp_test.description }}</td>
                <td>{{ bgp_test.testipv4prefix }}</td>
                <td>{{ bgp_test.checkasinpath }}</td>
                <td>
                    {% if result.passed %}
                    <span class="pass">‚úÖ</span>
                    {% else %}
                    <span class="fail">‚ùå</span>
                    {% endif %}
                </td>
            </tr>
            <tr class="details-row" id="bgp-{{ test_instance.id }}">
                <td colspan="5">
                    <strong>Tested from Device:</strong> {{ device.hostname }} ({{device.mgmtip}})<br>
                    <strong>Command output:</strong><br>
                    <pre>{{ result.rawoutput }}</pre>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Traceroute Tests Table -->
    <h2>Traceroute Tests</h2>
    <table class="table table-striped" id="traceroute-table">
        <thead>
            <tr>
                <th class="sortable">Tested from Device</th>
                <th class="sortable">Test Description</th>
                <th class="sortable">Source IP</th>
                <th class="sortable">Destination IP</th>
                <th class="sortable">Result</th>
            </tr>
        </thead>
        <tbody>
            {% for test_instance, result, device, traceroute_test in traceroute_results %}
            <tr class="summary-row" data-toggle-id="traceroute-{{ test_instance.id }}">
                <td>{{ device.siteinfo or device.hostname }}</td>
                <td>{{ traceroute_test.description }}</td>
                <td>{{ device.lanip }}</td>
                <td>{{ traceroute_test.destinationip }}</td>
                <td>
                    {% if result.passed is not none %}
                    {% if result.passed %}
                    <span class="pass">‚úÖ</span>
                    {% else %}
                    <span class="fail">‚ùå</span>
                    {% endif %}
                    {% else %}
                    <span>‚Äì</span>
                    {% endif %}
                </td>
            </tr>
            <tr class="details-row" id="traceroute-{{ test_instance.id }}">
                <td colspan="5">
                    <strong>Device:</strong> {{ device.hostname }}<br>
                    <strong>Raw Output:</strong><br>
                    <pre>{{ result.rawoutput }}</pre>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Expand/collapse rows
    document.querySelectorAll('.summary-row').forEach(row => {
        row.addEventListener('click', () => {
            const detailsId = row.getAttribute('data-toggle-id');
            const detailsRow = document.getElementById(detailsId);
            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                detailsRow.style.display = 'table-row';
            } else {
                detailsRow.style.display = 'none';
            }
        });
    });

    // Table sorting function with paired rows
    function sortTable(tableId, colIndex, isNumeric = false) {
        const table = document.getElementById(tableId);
        let switching = true;
        let shouldSwitch, i, dir = "asc", switchCount = 0;

        while (switching) {
            switching = false;
            const rows = table.querySelectorAll('tbody tr.summary-row');

            for (i = 0; i < rows.length - 1; i++) {
                shouldSwitch = false;
                const x = rows[i].getElementsByTagName("td")[colIndex];
                const y = rows[i + 1].getElementsByTagName("td")[colIndex];
                let xContent = x.innerText;
                let yContent = y.innerText;

                if (isNumeric) {
                    xContent = parseFloat(xContent) || xContent;
                    yContent = parseFloat(yContent) || yContent;
                }

                if (dir === "asc") {
                    if (xContent > yContent) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir === "desc") {
                    if (xContent < yContent) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }

            if (shouldSwitch) {
                const summaryRow1 = rows[i];
                const summaryRow2 = rows[i + 1];
                const detailsRow1 = document.getElementById(summaryRow1.getAttribute('data-toggle-id'));
                const detailsRow2 = document.getElementById(summaryRow2.getAttribute('data-toggle-id'));

                summaryRow1.parentNode.insertBefore(summaryRow2, summaryRow1);
                summaryRow1.parentNode.insertBefore(detailsRow2, summaryRow1);

                switching = true;
                switchCount++;
            } else if (switchCount === 0 && dir === "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }

    // Attach sorting to column headers
    document.querySelectorAll('.sortable').forEach((th, index) => {
        th.addEventListener('click', () => {
            const tableId = th.closest('table').id;
            const isNumeric = [2, 3].includes(index);
            sortTable(tableId, index, isNumeric);
        });
    });
</script>
{% endblock %}