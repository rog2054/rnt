{% extends 'base.html' %}
{% block title %}Test Progress{% endblock %}
{% block content %}
<h1>Test Run: {{ test_run.description }}</h1>
<p>Started: {{ test_run.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
<h2>Progress</h2>
<p>BGP AS Path Tests:
    Completed: <span id="bgp_completed">{{ stats.bgpaspath_test.completed }}</span> /
    Running: <span id="bgp_running">{{ stats.bgpaspath_test.running }}</span> /
    Skipped: <span id="bgp_skipped">{{ stats.bgpaspath_test.skipped }}</span> /
    Total: <span id="bgp_total">{{ stats.bgpaspath_test.total }}</span>
</p>
<p>Traceroute Tests:
    Completed: <span id="traceroute_completed">{{ stats.traceroute_test.completed }}</span> /
    Running: <span id="traceroute_running">{{ stats.traceroute_test.running }}</span> /
    Skipped: <span id="traceroute_skipped">{{ stats.traceroute_test.skipped }}</span> /
    Total: <span id="traceroute_total">{{ stats.traceroute_test.total }}</span>
</p>
<p>TxRx SFP Transceiver Tests:
    Completed: <span id="txrxtransceiver_completed">{{ stats.txrxtransceiver_test.completed }}</span> /
    Running: <span id="txrxtransceiver_running">{{ stats.txrxtransceiver_test.running }}</span> /
    Skipped: <span id="txrxtransceiver_skipped">{{ stats.txrxtransceiver_test.skipped }}</span> /
    Total: <span id="txrxtransceiver_total">{{ stats.txrxtransceiver_test.total }}</span>
</p>
<p>ACI itraceroute Tests:
    Completed: <span id="itraceroute_completed">{{ stats.itraceroute_test.completed }}</span> /
    Running: <span id="itraceroute_running">{{ stats.itraceroute_test.running }}</span> /
    Skipped: <span id="itraceroute_skipped">{{ stats.itraceroute_test.skipped }}</span> /
    Total: <span id="itraceroute_total">{{ stats.itraceroute_test.total }}</span>
</p>
<h2>Status Updates</h2>
<div id="status-log" class="border p-3" style="height: 450px; overflow-y: auto;"></div>

<div id="results-button" style="display:none;">
    <a href="{{ url_for('test_results', run_id=test_run.id) }}/pass" class="btn btn-primary mt-3">View Results</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const currentRunId = {{ run_id | tojson | safe
    }};
    const socket = io();
    const deviceLogs = new Map();
    let runCompletedMessage = '';
    const deviceOrder = [];

    socket.on('connect', function () {
        console.log('Connected to Socket.IO server');
        socket.emit('start_tests', { run_id: currentRunId });
    });

    socket.on('connect_error', function (error) {
        console.error('Socket.IO connection error:', error);
    });

    socket.on('status_update', function (data) {
        console.log('Received status_update:', data);
        if (data.run_id !== currentRunId) {
            console.log('Message ignored, run_id mismatch:', data.run_id, '!=', currentRunId);
            return;
        }

        const log = document.getElementById('status-log');
        if (!log) {
            console.error('Status log element not found');
            return;
        }

        if (data.level === 'parent' && !data.device_id) {
            runCompletedMessage = '<div class="parent">' + data.message + '</div>';
        } else if (data.level === 'parent' && data.device_id) {
            if (!deviceLogs.has(data.device_id)) {
                deviceLogs.set(data.device_id, {
                    parent: '<div class="parent">' + data.message + '</div>',
                    children: ['<li class="child">...running</li>']
                });
                deviceOrder.push(data.device_id);
            } else {
                console.warn('Duplicate parent message ignored for device_id:', data.device_id, data.message);
            }
        } else if (data.level === 'child' && data.device_id) {
            if (!deviceLogs.has(data.device_id)) {
                deviceLogs.set(data.device_id, {
                    parent: '<div class="parent">Device ' + data.device_id + ' (pending connection info)</div>',
                    children: ['<li class="child">...running</li>']
                });
                deviceOrder.push(data.device_id);
            }
            const deviceLog = deviceLogs.get(data.device_id);
            const newChildMessage = '<li class="child">' + data.message + '</li>';

            // If the initial "...running" placeholder is still there, replace it
            if (deviceLog.children.length === 1 && deviceLog.children[0] === '<li class="child">...running</li>') {
                deviceLog.children = [newChildMessage];
            } else if (!deviceLog.children.includes(newChildMessage)) {
                // Add the new message and keep only the latest 2
                deviceLog.children.push(newChildMessage);
                if (deviceLog.children.length > 2) {
                    deviceLog.children.shift(); // Remove the oldest message
                }
            }
        }

        log.innerHTML = '';
        deviceOrder.forEach(deviceId => {
            const deviceLog = deviceLogs.get(deviceId);
            log.innerHTML += deviceLog.parent;
            if (deviceLog.children.length > 0) {
                log.innerHTML += '<ul>' + deviceLog.children.join('') + '</ul>';
            }
        });
        if (runCompletedMessage) {
            log.innerHTML += runCompletedMessage;
            document.getElementById('results-button').style.display = 'block';
        }
        log.scrollTop = log.scrollHeight;
    });

    socket.on('stats_update', function (data) {
        console.log('Received stats_update:', data);
        if (data.run_id === currentRunId) {
            const stats = data.stats;
            document.getElementById('bgp_completed').textContent = stats.bgpaspath_test.completed;
            document.getElementById('bgp_running').textContent = stats.bgpaspath_test.running;
            document.getElementById('bgp_skipped').textContent = stats.bgpaspath_test.skipped;
            document.getElementById('bgp_total').textContent = stats.bgpaspath_test.total;
            document.getElementById('traceroute_completed').textContent = stats.traceroute_test.completed;
            document.getElementById('traceroute_running').textContent = stats.traceroute_test.running;
            document.getElementById('traceroute_skipped').textContent = stats.traceroute_test.skipped;
            document.getElementById('traceroute_total').textContent = stats.traceroute_test.total;
            document.getElementById('txrxtransceiver_completed').textContent = stats.txrxtransceiver_test.completed;
            document.getElementById('txrxtransceiver_running').textContent = stats.txrxtransceiver_test.running;
            document.getElementById('txrxtransceiver_skipped').textContent = stats.txrxtransceiver_test.skipped;
            document.getElementById('txrxtransceiver_total').textContent = stats.txrxtransceiver_test.total;
            document.getElementById('itraceroute_completed').textContent = stats.itraceroute_test.completed;
            document.getElementById('itraceroute_running').textContent = stats.itraceroute_test.running;
            document.getElementById('itraceroute_skipped').textContent = stats.itraceroute_test.skipped;
            document.getElementById('itraceroute_total').textContent = stats.itraceroute_test.total;
        }
    });
    }); // End of DOMContentLoaded
</script>
{% endblock %}